{% import 'macros/form.html' as form %}
{% include 'scheming/snippets/suggestions_asset.html' %}
{% include 'scheming/snippets/ai_suggestions_asset.html' %}


{# Check if this is a preformulated field #}
{% set is_preformulated = h.is_preformulated_field(field) %}
{% set supports_ai_suggestion = h.scheming_field_supports_ai_suggestion(field) %}

{# Create a custom label with suggestion button(s) and icons #}
{% set suggestion = h.scheming_field_suggestion(field) %}
{% set label_text = h.scheming_language_text(field.label) %}
{% set label_with_extras %}
<span class="form-label">{{ label_text }}:</span>
{%- if suggestion -%}
{%- snippet 'scheming/snippets/suggestion_button.html', field=field, data=data -%}
{%- endif -%}
    {%- if supports_ai_suggestion -%}
      {% set ai_suggestion_value = h.scheming_get_ai_suggestion_value(field.field_name, data) %}
      {% set ai_suggestion_source = h.scheming_get_ai_suggestion_source(field.field_name, data) %}
      <button type="button" class="ai-suggestion-btn" title="AI Suggestion Available" data-module="scheming-ai-suggestions" data-field-name="{{ field.field_name }}" data-suggestion-value="{{ ai_suggestion_value }}" data-suggestion-source="{{ ai_suggestion_source or 'AI Generated' }}">
        <svg xmlns="http://www.w3.org/2000/svg" version="1.1" viewBox="-5.0 -10.0 110.0 135.0">
          <path d="m49.988 1.7656c-2.6641 0-5.3281 0.14844-7.9727 0.44531-1.875 0.21094-3.5156 1.1562-4.5 2.5938-0.82031 1.1953-1.0938 2.5938-0.78125 3.9609-11.805 3.8203-20.672 13.5-23.727 25.211h-2.3359c-4.9141 0-8.9141 4-8.9141 8.9141v3.875c0 4.9141 4 8.9141 8.9141 8.9141h2.75c2.4297 5.5859 7.4844 9.7812 13.594 11.023-0.41406 0.22656-0.82031 0.46875-1.2188 0.72656h-11.141c-7.1172 0-12.898 5.7891-12.898 12.898v7.0703c0 0.75781 0.60938 1.3672 1.3672 1.3672h2.6797c-0.054688 0.45312-0.085938 0.89844-0.085938 1.3438 0 2.7812 0.97656 5.4922 2.7422 7.6328 0.25781 0.3125 0.64844 0.49219 1.0547 0.49219h80.961c0.40625 0 0.79688-0.17969 1.0547-0.49219 1.7656-2.1406 2.7422-4.8516 2.7422-7.6328 0-0.44531-0.03125-0.89844-0.085938-1.3438h2.6875c0.75781 0 1.3672-0.60938 1.3672-1.3672v-7.0703c-0.023438-7.1016-5.8125-12.891-12.922-12.891h-11.141c-0.39844-0.25781-0.80469-0.5-1.2188-0.72656 6.1094-1.2422 11.164-5.4375 13.594-11.023h2.75c4.9141 0 8.9141-4 8.9141-8.9141v-3.875c0-3.5312-2.0703-6.5781-5.0469-8.0234v-14.211c2.2812-0.60937 3.9688-2.6797 3.9688-5.1484 0-2.9375-2.3906-5.3359-5.3359-5.3359-2.9453 0-5.3359 2.3906-5.3359 5.3359 0 2.4688 1.6875 4.5469 3.9688 5.1484v13.398c-0.375-0.046875-0.75-0.078125-1.1328-0.078125h-2.3359c-3.0547-11.711-11.93-21.391-23.727-25.211 0.30469-1.3672 0.039062-2.7656-0.78125-3.9688-0.98438-1.4375-2.625-2.3828-4.5-2.5938-2.6445-0.29688-5.3086-0.44531-7.9727-0.44531zm-0.011719 2.7344c2.5625 0 5.125 0.14062 7.6641 0.42969 1.0859 0.125 2.0156 0.64062 2.5547 1.4219 0.28125 0.41406 0.57813 1.0781 0.35938 1.9062l-0.83594 3.1875c-0.52344 1.9922-2.7109 3.4375-5.2031 3.4375h-9.0703c-2.4922 0-4.6797-1.4453-5.2031-3.4375l-0.55469-2.1172-0.28125-1.0703c-0.21875-0.82812 0.070312-1.4922 0.35156-1.9062 0.53906-0.78125 1.4688-1.3047 2.5547-1.4219 2.5469-0.28906 5.1016-0.42969 7.6641-0.42969zm-12.578 6.9219 0.1875 0.71875c0.84375 3.2266 4.0781 5.4766 7.8516 5.4766h9.0703c3.7734 0 7-2.25 7.8516-5.4766l0.1875-0.71875c13.516 4.4453 22.836 17.227 22.836 31.562v5.1719c0 8.9297-7.2656 16.203-16.203 16.203h-38.414c-8.9297 0-16.203-7.2656-16.203-16.203v-5.1719c0-14.328 9.3203-27.117 22.836-31.562zm54.406 1.4922c1.4375 0 2.6016 1.1641 2.6016 2.6016s-1.1641 2.6016-2.6016 2.6016-2.6016-1.1719-2.6016-2.6016 1.1641-2.6016 2.6016-2.6016zm-50.727 13.266c-10.25 0-18.586 8.3359-18.586 18.586v2.7031c0 5.5781 4.5391 10.109 10.109 10.109h34.742c5.5781 0 10.109-4.5312 10.109-10.109v-2.7031c0-10.25-8.3359-18.586-18.586-18.586zm0.007813 2.7344h17.789c8.7422 0 15.852 7.1094 15.852 15.852v2.7031c0 4.0703-3.3125 7.375-7.375 7.375h-34.742c-4.0703 0-7.375-3.3047-7.375-7.375v-2.7031c0-8.7422 7.1094-15.852 15.852-15.852zm-30.438 7.8047h1.7422c-0.36719 2.0469-0.5625 4.1406-0.5625 6.2656v5.1719c0 1.6562 0.21875 3.2656 0.61719 4.7969h-1.7969c-3.4062 0-6.1797-2.7734-6.1797-6.1797v-3.875c0-3.4062 2.7734-6.1797 6.1797-6.1797zm76.906 0h1.7422c3.4062 0 6.1797 2.7734 6.1797 6.1797v3.875c0 3.4062-2.7734 6.1797-6.1797 6.1797h-1.7969c0.39844-1.5312 0.61719-3.1406 0.61719-4.7969v-5.1719c0-2.125-0.19531-4.2188-0.5625-6.2656zm-49.684 5.3047c-1.668 0-3.332 0.63281-4.5977 1.8984-0.53125 0.53125-0.53125 1.3984 0 1.9297s1.3984 0.53125 1.9297 0c1.4688-1.4688 3.8672-1.4688 5.3359 0 0.26563 0.26563 0.61719 0.39844 0.96875 0.39844 0.35156 0 0.70313-0.13281 0.96875-0.39844 0.53125-0.53125 0.53125-1.3984 0-1.9297-1.2695-1.2656-2.9375-1.8984-4.6055-1.8984zm24.211 0c-1.668 0-3.332 0.63281-4.5977 1.8984-0.53125 0.53125-0.53125 1.3984 0 1.9297s1.3984 0.53125 1.9297 0c1.4688-1.4688 3.8672-1.4688 5.3359 0 0.26562 0.26563 0.61719 0.39844 0.96875 0.39844s0.70312-0.13281 0.96875-0.39844c0.53125-0.53125 0.53125-1.3984 0-1.9297-1.2695-1.2656-2.9375-1.8984-4.6055-1.8984zm-25.941 25.062h27.68c4.5625 0 8.9375 1.9297 12.008 5.3047 3.0625 3.375 4.5859 7.9062 4.1562 12.445l-0.99219 10.68h-58.031l-0.99219-10.68c-0.42188-4.5391 1.0938-9.0781 4.1641-12.445 3.0703-3.3672 7.4453-5.3047 12.008-5.3047zm-21.508 3.0938h7.8359c-0.125 0.125-0.24219 0.25-0.36719 0.375-3.5859 3.9375-5.3594 9.2344-4.8672 14.539l0.085937 0.95312h-12.859v-5.7031h0.007812c0-5.6094 4.5625-10.164 10.164-10.164zm62.836 0h7.8359c5.6094 0 10.164 4.5625 10.164 10.164v5.7031h-12.852l0.085937-0.95312c0.49219-5.3047-1.2812-10.602-4.8672-14.539-0.11719-0.13281-0.24219-0.25-0.36719-0.375zm-39.812 6.5625c-3.9297 0-7.125 3.1953-7.125 7.125 0 3.9297 3.1953 7.125 7.125 7.125h24.641c3.9297 0 7.125-3.1953 7.125-7.125 0-3.9297-3.1953-7.125-7.125-7.125zm0 2.7422h24.641c2.4219 0 4.3906 1.9688 4.3906 4.3906s-1.9688 4.3906-4.3906 4.3906h-24.641c-2.4219 0-4.3906-1.9688-4.3906-4.3906s1.9688-4.3906 4.3906-4.3906zm-29.102 9.2969h9.0391l0.625 6.7344h-8.0469c-1.125-1.5625-1.7344-3.4531-1.7344-5.3906 0-0.44531 0.046875-0.89062 0.11719-1.3438zm73.805 0h9.0391c0.070312 0.45312 0.11719 0.89844 0.11719 1.3438 0 1.9375-0.60938 3.8281-1.7344 5.3906h-8.0469z"/>
         </svg>
      </button>
    {%- endif -%}
{%- if is_preformulated -%}
<span class="preformulated-icon" title="This field is automatically populated">
  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
    stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
  </svg>
</span>
{%- endif -%}
{% endset %}

{# Prepare attributes for the form macro #}
{% set current_attrs = {} %}
{% if supports_ai_suggestion %}
{% set _ = current_attrs.update({'data-field-supports-ai-suggestion': 'true'}) %}
{% endif %}
{% if is_preformulated %} {# is_preformulated means it has a 'formula' #}
{% set _ = current_attrs.update({'data-is-formula-field': 'true'}) %}
{% endif %}
{# Always add data-scheming-field-name for easier targeting by JS #}
{% set _ = current_attrs.update({'data-scheming-field-name': field.field_name}) %}


{% call form.markdown(
field.field_name,
id='field-' + field.field_name,
label=label_with_extras|safe,
placeholder=h.scheming_language_text(field.form_placeholder),
value=data[field.field_name],
error=errors[field.field_name],
attrs=current_attrs,
is_required=h.scheming_field_required(field)
)
%}
<div class="suggestion-field-wrapper {% if is_preformulated %}preformulated-field{% endif %}">
  {%- if is_preformulated -%}
  <div class="preformulated-field-notice">
    <strong>Automated field:</strong> This field is automatically populated.
  </div>
  {%- endif -%}
  {%- snippet 'scheming/form_snippets/help_text.html', field=field -%}
</div>
{% endcall %}